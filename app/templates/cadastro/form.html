{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h2>Cadastro Individual</h2>
        </div>
        <div class="card-body">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" class="needs-validation" novalidate>
                {{ form.csrf_token }}
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form.digitado_por.label(class="form-label") }}
                        {{ form.digitado_por(class="form-control", readonly=true) }}
                    </div>
                    <div class="col-md-6">
                        {{ form.data_digitacao.label(class="form-label") }}
                        {{ form.data_digitacao(class="form-control", readonly=true) }}
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Dados do Profissional</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">CNS do Profissional</label>
                                <p class="form-control-static">{{ dados_profissional.cns_profissional }}</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">CBO</label>
                                <p class="form-control-static">{{ dados_profissional.cbo }}</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">CNES</label>
                                <p class="form-control-static">{{ dados_profissional.cnes }}</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">INE</label>
                                <p class="form-control-static">{{ dados_profissional.ine }}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                {{ form.microarea.label(class="form-label") }}
                                {{ form.microarea(class="form-control", readonly=true) }}
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mt-4">
                                    {{ form.fora_area(class="form-check-input") }}
                                    {{ form.fora_area.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data do Cadastro</label>
                                <p class="form-control-static">{{ dados_profissional.data_cadastro }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Identificação do Cidadão</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.nome_completo.label(class="form-label") }}
                                {{ form.nome_completo(class="form-control" + (" is-invalid" if form.nome_completo.errors else "")) }}
                                {% if form.nome_completo.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.nome_completo.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.nome_social.label(class="form-label") }}
                                {{ form.nome_social(class="form-control") }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.data_nascimento.label(class="form-label") }}
                                {{ form.data_nascimento(class="form-control" + (" is-invalid" if form.data_nascimento.errors else ""),
                                                       placeholder="DD/MM/AAAA",
                                                       maxlength="10") }}
                                <small class="form-text text-muted">Formato: DD/MM/AAAA</small>
                                {% if form.data_nascimento.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.data_nascimento.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.sexo.label(class="form-label") }}
                                {{ form.sexo(class="form-control" + (" is-invalid" if form.sexo.errors else "")) }}
                                {% if form.sexo.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.sexo.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.raca_cor.label(class="form-label") }}
                                {{ form.raca_cor(class="form-control" + (" is-invalid" if form.raca_cor.errors else "")) }}
                                {% if form.raca_cor.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.raca_cor.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3" id="etnia-container" style="display: none;">
                                {{ form.etnia.label(class="form-label") }}
                                {{ form.etnia(class="form-control" + (" is-invalid" if form.etnia.errors else "")) }}
                                {% if form.etnia.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.etnia.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.numero_nis.label(class="form-label") }}
                                {{ form.numero_nis(class="form-control" + (" is-invalid" if form.numero_nis.errors else "")) }}
                                {% if form.numero_nis.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.numero_nis.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    {{ form.nome_mae.label(class="form-label") }}
                                    <div class="form-check">
                                        {{ form.mae_desconhecida(class="form-check-input") }}
                                        {{ form.mae_desconhecida.label(class="form-check-label") }}
                                    </div>
                                </div>
                                {{ form.nome_mae(class="form-control" + (" is-invalid" if form.nome_mae.errors else "")) }}
                                {% if form.nome_mae.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.nome_mae.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    {{ form.nome_pai.label(class="form-label") }}
                                    <div class="form-check">
                                        {{ form.pai_desconhecido(class="form-check-input") }}
                                        {{ form.pai_desconhecido.label(class="form-check-label") }}
                                    </div>
                                </div>
                                {{ form.nome_pai(class="form-control" + (" is-invalid" if form.nome_pai.errors else "")) }}
                                {% if form.nome_pai.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.nome_pai.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.nacionalidade.label(class="form-label") }}
                                {{ form.nacionalidade(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.pais_nascimento.label(class="form-label") }}
                                {{ form.pais_nascimento(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.data_naturalizacao.label(class="form-label") }}
                                {{ form.data_naturalizacao(class="form-control" + (" is-invalid" if form.data_naturalizacao.errors else ""),
                                                       placeholder="DD/MM/AAAA",
                                                       maxlength="10") }}
                                <small class="form-text text-muted">Formato: DD/MM/AAAA</small>
                                {% if form.data_naturalizacao.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.data_naturalizacao.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.portaria_naturalizacao.label(class="form-label") }}
                                {{ form.portaria_naturalizacao(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.municipio_nascimento.label(class="form-label") }}
                                {{ form.municipio_nascimento(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.uf_nascimento.label(class="form-label") }}
                                {{ form.uf_nascimento(class="form-control") }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.data_entrada_brasil.label(class="form-label") }}
                                {{ form.data_entrada_brasil(class="form-control" + (" is-invalid" if form.data_entrada_brasil.errors else ""),
                                                       placeholder="DD/MM/AAAA",
                                                       maxlength="10") }}
                                <small class="form-text text-muted">Formato: DD/MM/AAAA</small>
                                {% if form.data_entrada_brasil.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.data_entrada_brasil.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.telefone_celular.label(class="form-label") }}
                                {{ form.telefone_celular(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.email.label(class="form-label") }}
                                {{ form.email(class="form-control") }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.cns_cidadao.label(class="form-label") }}
                                {{ form.cns_cidadao(class="form-control" + (" is-invalid" if form.cns_cidadao.errors else "")) }}
                                {% if form.cns_cidadao.errors %}
                                    <div class="invalid-feedback">{{ form.cns_cidadao.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.cpf_cidadao.label(class="form-label") }}
                                {{ form.cpf_cidadao(class="form-control" + (" is-invalid" if form.cpf_cidadao.errors else "")) }}
                                {% if form.cpf_cidadao.errors %}
                                    <div class="invalid-feedback">{{ form.cpf_cidadao.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="form-check">
                                    {{ form.responsavel_familiar(class="form-check-input") }}
                                    {{ form.responsavel_familiar.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <div id="dados_responsavel" class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.cns_responsavel.label(class="form-label") }}
                                {{ form.cns_responsavel(class="form-control" + (" is-invalid" if form.cns_responsavel.errors else "")) }}
                                {% if form.cns_responsavel.errors %}
                                    <div class="invalid-feedback">{{ form.cns_responsavel.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.cpf_responsavel.label(class="form-label") }}
                                {{ form.cpf_responsavel(class="form-control" + (" is-invalid" if form.cpf_responsavel.errors else "")) }}
                                {% if form.cpf_responsavel.errors %}
                                    <div class="invalid-feedback">{{ form.cpf_responsavel.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Informações Sociodemográficas</h5>
                    </div>
                    <div class="card-body">
                        <!-- Relação de Parentesco -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.parentesco_responsavel.label(class="form-label") }}
                                {{ form.parentesco_responsavel(class="form-control" + (" is-invalid" if form.parentesco_responsavel.errors else "")) }}
                                {% if form.parentesco_responsavel.errors %}
                                    <div class="invalid-feedback">{{ form.parentesco_responsavel.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Escola/Creche -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.frequenta_escola(class="form-check-input") }}
                                    {{ form.frequenta_escola.label(class="form-check-label") }}
                                </div>
                                <div id="curso-container">
                                    {{ form.curso_frequenta.label(class="form-label") }}
                                    {{ form.curso_frequenta(class="form-select" + (" is-invalid" if form.curso_frequenta.errors else "")) }}
                                    {% if form.curso_frequenta.errors %}
                                        <div class="invalid-feedback">{{ form.curso_frequenta.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Situação no Mercado de Trabalho -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.situacao_trabalho.label(class="form-label") }}
                                {{ form.situacao_trabalho(class="form-select" + (" is-invalid" if form.situacao_trabalho.errors else "")) }}
                                {% if form.situacao_trabalho.errors %}
                                    <div class="invalid-feedback">{{ form.situacao_trabalho.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Ocupação -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.ocupacao.label(class="form-label") }}
                                {{ form.ocupacao(class="form-control" + (" is-invalid" if form.ocupacao.errors else "")) }}
                                {% if form.ocupacao.errors %}
                                    <div class="invalid-feedback">{{ form.ocupacao.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Crianças 0-9 anos -->
                        <div class="row mb-3" id="crianca-container">
                            <div class="col-md-6">
                                {{ form.crianca_ficacom.label(class="form-label") }}
                                {{ form.crianca_ficacom(class="form-control") }}
                            </div>
                        </div>

                        <!-- Campos Sim/Não -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.frequenta_cuidador(class="form-check-input") }}
                                    {{ form.frequenta_cuidador.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.participa_grupo(class="form-check-input") }}
                                    {{ form.participa_grupo.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.possui_plano_saude(class="form-check-input") }}
                                    {{ form.possui_plano_saude.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Comunidade Tradicional -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.membro_comunidade(class="form-check-input") }}
                                    {{ form.membro_comunidade.label(class="form-check-label") }}
                                </div>
                                <div id="qual-comunidade-container" style="display: none;">
                                    {{ form.qual_comunidade.label(class="form-label") }}
                                    {{ form.qual_comunidade(class="form-control" + (" is-invalid" if form.qual_comunidade.errors else "")) }}
                                    {% if form.qual_comunidade.errors %}
                                        <div class="invalid-feedback">{{ form.qual_comunidade.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Orientação Sexual -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.informa_orientacao(class="form-check-input") }}
                                    {{ form.informa_orientacao.label(class="form-check-label") }}
                                </div>
                                <div id="orientacao-container" style="display: none;">
                                    {{ form.orientacao_sexual.label(class="form-label") }}
                                    {{ form.orientacao_sexual(class="form-control" + (" is-invalid" if form.orientacao_sexual.errors else "")) }}
                                    {% if form.orientacao_sexual.errors %}
                                        <div class="invalid-feedback">{{ form.orientacao_sexual.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Identidade de Gênero -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.informa_identidade(class="form-check-input") }}
                                    {{ form.informa_identidade.label(class="form-check-label") }}
                                </div>
                                <div id="identidade-container" style="display: none;">
                                    {{ form.identidade_genero.label(class="form-label") }}
                                    {{ form.identidade_genero(class="form-control" + (" is-invalid" if form.identidade_genero.errors else "")) }}
                                    {% if form.identidade_genero.errors %}
                                        <div class="invalid-feedback">{{ form.identidade_genero.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Deficiência -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.tem_deficiencia(class="form-check-input") }}
                                    {{ form.tem_deficiencia.label(class="form-check-label") }}
                                </div>
                                <div id="deficiencias-container" style="display: none;">
                                    {{ form.deficiencias.label(class="form-label") }}
                                    {{ form.deficiencias(class="form-select" + (" is-invalid" if form.deficiencias.errors else "")) }}
                                    {% if form.deficiencias.errors %}
                                        <div class="invalid-feedback">{{ form.deficiencias.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Saída do Cadastro -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                {{ form.motivo_saida.label(class="form-label") }}
                                {{ form.motivo_saida(class="form-control") }}
                            </div>
                            <div class="col-md-4" id="data-obito-container" style="display: none;">
                                {{ form.data_obito.label(class="form-label") }}
                                {{ form.data_obito(class="form-control" + (" is-invalid" if form.data_obito.errors else "")) }}
                                {% if form.data_obito.errors %}
                                    <div class="invalid-feedback">{{ form.data_obito.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4" id="numero-do-container" style="display: none;">
                                {{ form.numero_do.label(class="form-label") }}
                                {{ form.numero_do(class="form-control" + (" is-invalid" if form.numero_do.errors else "")) }}
                                {% if form.numero_do.errors %}
                                    <div class="invalid-feedback">{{ form.numero_do.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- TRIA -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <h6 class="mb-3">Triagem para Risco de Insegurança Alimentar (TRIA)</h6>
                                <div class="form-check mb-2">
                                    {{ form.tria_alimentos_acabaram(class="form-check-input") }}
                                    {{ form.tria_alimentos_acabaram.label(class="form-check-label") }}
                                </div>
                                <div class="form-check">
                                    {{ form.tria_comeu_alguns(class="form-check-input") }}
                                    {{ form.tria_comeu_alguns.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Condições/Situações de Saúde</h5>
                    </div>
                    <div class="card-body">
                        <!-- Gestante -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.esta_gestante(class="form-check-input") }}
                                    {{ form.esta_gestante.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-8" id="maternidade-container" style="display: none;">
                                {{ form.maternidade_referencia.label(class="form-label") }}
                                {{ form.maternidade_referencia(class="form-control" + (" is-invalid" if form.maternidade_referencia.errors else "")) }}
                                {% if form.maternidade_referencia.errors %}
                                    <div class="invalid-feedback">{{ form.maternidade_referencia.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Peso -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.consideracao_peso.label(class="form-label") }}
                                <span class="text-danger">*</span>
                                {{ form.consideracao_peso(class="form-control" + (" is-invalid" if form.consideracao_peso.errors else "")) }}
                                {% if form.consideracao_peso.errors %}
                                    <div class="invalid-feedback">{{ form.consideracao_peso.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Doença Respiratória -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.tem_doenca_respiratoria(class="form-check-input") }}
                                    {{ form.tem_doenca_respiratoria.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-8" id="doenca-respiratoria-container" style="display: none;">
                                {{ form.tipo_doenca_respiratoria.label(class="form-label") }}
                                {{ form.tipo_doenca_respiratoria(class="form-control" + (" is-invalid" if form.tipo_doenca_respiratoria.errors else "")) }}
                                {% if form.tipo_doenca_respiratoria.errors %}
                                    <div class="invalid-feedback">{{ form.tipo_doenca_respiratoria.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Hábitos -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.fumante(class="form-check-input") }}
                                    {{ form.fumante.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.uso_alcool(class="form-check-input") }}
                                    {{ form.uso_alcool.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.uso_drogas(class="form-check-input") }}
                                    {{ form.uso_drogas.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Doenças Crônicas -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="form-check">
                                    {{ form.hipertensao_arterial(class="form-check-input") }}
                                    {{ form.hipertensao_arterial.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    {{ form.diabetes(class="form-check-input") }}
                                    {{ form.diabetes.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    {{ form.teve_avc(class="form-check-input") }}
                                    {{ form.teve_avc.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    {{ form.teve_infarto(class="form-check-input") }}
                                    {{ form.teve_infarto.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Doença Cardíaca -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.tem_doenca_cardiaca(class="form-check-input") }}
                                    {{ form.tem_doenca_cardiaca.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-8" id="doenca-cardiaca-container" style="display: none;">
                                {{ form.tipo_doenca_cardiaca.label(class="form-label") }}
                                {{ form.tipo_doenca_cardiaca(class="form-control" + (" is-invalid" if form.tipo_doenca_cardiaca.errors else "")) }}
                                {% if form.tipo_doenca_cardiaca.errors %}
                                    <div class="invalid-feedback">{{ form.tipo_doenca_cardiaca.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Problemas Renais -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.tem_problema_rins(class="form-check-input") }}
                                    {{ form.tem_problema_rins.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-8" id="problema-rins-container" style="display: none;">
                                {{ form.tipo_problema_rins.label(class="form-label") }}
                                {{ form.tipo_problema_rins(class="form-control" + (" is-invalid" if form.tipo_problema_rins.errors else "")) }}
                                {% if form.tipo_problema_rins.errors %}
                                    <div class="invalid-feedback">{{ form.tipo_problema_rins.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Outras Doenças -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.hanseniase(class="form-check-input") }}
                                    {{ form.hanseniase.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.tuberculose(class="form-check-input") }}
                                    {{ form.tuberculose.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.cancer(class="form-check-input") }}
                                    {{ form.cancer.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Situações de Saúde -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.internacao_12_meses(class="form-check-input") }}
                                    {{ form.internacao_12_meses.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.problema_saude_mental(class="form-check-input") }}
                                    {{ form.problema_saude_mental.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.acamado(class="form-check-input") }}
                                    {{ form.acamado.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.domiciliado(class="form-check-input") }}
                                    {{ form.domiciliado.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Práticas Integrativas -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.usa_plantas_medicinais(class="form-check-input") }}
                                    {{ form.usa_plantas_medicinais.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.usa_praticas_integrativas(class="form-check-input") }}
                                    {{ form.usa_praticas_integrativas.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Outras Condições -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.outras_condicoes.label(class="form-label") }}
                                {{ form.outras_condicoes(class="form-control" + (" is-invalid" if form.outras_condicoes.errors else ""),
                                                     placeholder="Digite até 3 outras condições de saúde, separadas por vírgula") }}
                                {% if form.outras_condicoes.errors %}
                                    <div class="invalid-feedback">{{ form.outras_condicoes.errors[0] }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Separe as condições por vírgula. Máximo de 3 condições.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Situação de Rua</h5>
                    </div>
                    <div class="card-body">
                        <!-- Situação de Rua -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.situacao_rua(class="form-check-input") }}
                                    {{ form.situacao_rua.label(class="form-check-label") }}
                                </div>
                                <div id="situacao-rua-container" style="display: none;">
                                    {{ form.tempo_rua.label(class="form-label") }}
                                    {{ form.tempo_rua(class="form-select" + (" is-invalid" if form.tempo_rua.errors else "")) }}
                                    {% if form.tempo_rua.errors %}
                                        <div class="invalid-feedback">{{ form.tempo_rua.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Acompanhamento Institucional -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.acompanhado_instituicao(class="form-check-input") }}
                                    {{ form.acompanhado_instituicao.label(class="form-check-label") }}
                                </div>
                                <div id="instituicao-container" style="display: none;">
                                    {{ form.qual_instituicao.label(class="form-label") }}
                                    {{ form.qual_instituicao(class="form-control" + (" is-invalid" if form.qual_instituicao.errors else "")) }}
                                    {% if form.qual_instituicao.errors %}
                                        <div class="invalid-feedback">{{ form.qual_instituicao.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Benefícios -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.recebe_beneficio(class="form-check-input") }}
                                    {{ form.recebe_beneficio.label(class="form-check-label") }}
                                </div>
                                <div id="beneficio-container" style="display: none;">
                                    {{ form.qual_beneficio.label(class="form-label") }}
                                    {{ form.qual_beneficio(class="form-control" + (" is-invalid" if form.qual_beneficio.errors else "")) }}
                                    {% if form.qual_beneficio.errors %}
                                        <div class="invalid-feedback">{{ form.qual_beneficio.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Referência Familiar -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.possui_referencia_familiar(class="form-check-input") }}
                                    {{ form.possui_referencia_familiar.label(class="form-check-label") }}
                                </div>
                                <div id="referencia-familiar-container" style="display: none;">
                                    {{ form.grau_parentesco.label(class="form-label") }}
                                    {{ form.grau_parentesco(class="form-control" + (" is-invalid" if form.grau_parentesco.errors else "")) }}
                                    {% if form.grau_parentesco.errors %}
                                        <div class="invalid-feedback">{{ form.grau_parentesco.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Visitas Familiares -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.visita_familiar(class="form-check-input") }}
                                    {{ form.visita_familiar.label(class="form-check-label") }}
                                </div>
                                <div id="visita-familiar-container" style="display: none;">
                                    {{ form.frequencia_visitas.label(class="form-label") }}
                                    {{ form.frequencia_visitas(class="form-select" + (" is-invalid" if form.frequencia_visitas.errors else "")) }}
                                    {% if form.frequencia_visitas.errors %}
                                        <div class="invalid-feedback">{{ form.frequencia_visitas.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Higiene -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.acesso_higiene(class="form-check-input") }}
                                    {{ form.acesso_higiene.label(class="form-check-label") }}
                                </div>
                                <div id="higiene-container" style="display: none;">
                                    {{ form.tipos_higiene(class="form-select" + (" is-invalid" if form.tipos_higiene.errors else "")) }}
                                    {% if form.tipos_higiene.errors %}
                                        <div class="invalid-feedback">{{ form.tipos_higiene.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Alimentação -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.quantidade_alimentacao.label(class="form-label") }}
                                {{ form.quantidade_alimentacao(class="form-control" + (" is-invalid" if form.quantidade_alimentacao.errors else "")) }}
                                {% if form.quantidade_alimentacao.errors %}
                                    <div class="invalid-feedback">{{ form.quantidade_alimentacao.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ form.origem_alimentacao.label(class="form-label") }}
                                {{ form.origem_alimentacao(class="form-select" + (" is-invalid" if form.origem_alimentacao.errors else "")) }}
                                {% if form.origem_alimentacao.errors %}
                                    <div class="invalid-feedback">{{ form.origem_alimentacao.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer text-end">
                    <a href="{{ url_for('cadastro.lista_cadastros') }}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Salvar Cadastro</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejo de etnia para indígenas
    const racaCorSelect = document.getElementById('raca_cor');
    const etniaContainer = document.getElementById('etnia-container');
    
    racaCorSelect.addEventListener('change', function() {
        etniaContainer.style.display = this.value === 'indigena' ? 'block' : 'none';
    });

    // Manejo de campos desconhecidos
    const maeDesconhecida = document.getElementById('mae_desconhecida');
    const nomeMae = document.getElementById('nome_mae');
    const paiDesconhecido = document.getElementById('pai_desconhecido');
    const nomePai = document.getElementById('nome_pai');

    maeDesconhecida.addEventListener('change', function() {
        nomeMae.disabled = this.checked;
        if (this.checked) {
            nomeMae.value = 'Desconhecido';
        } else {
            nomeMae.value = '';
        }
    });

    paiDesconhecido.addEventListener('change', function() {
        nomePai.disabled = this.checked;
        if (this.checked) {
            nomePai.value = 'Desconhecido';
        } else {
            nomePai.value = '';
        }
    });

    // Formateo de fechas
    function formatDate(input) {
        let value = input.value.replace(/\D/g, '');
        
        if (value.length > 0) {
            if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length > 5) {
                value = value.substring(0, 5) + '/' + value.substring(5);
            }
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
        }
        
        input.value = value;
    }

    const dateFields = ['data_nascimento', 'data_naturalizacao', 'data_entrada_brasil'];
    
    dateFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function(e) {
                formatDate(this);
            });
            
            field.addEventListener('paste', function(e) {
                e.preventDefault();
                let text = (e.originalEvent || e).clipboardData.getData('text/plain');
                text = text.replace(/\D/g, '');
                setTimeout(() => {
                    this.value = text;
                    formatDate(this);
                }, 0);
            });
        }
    });

    // Manejo de campos según nacionalidad
    const nacionalidadeSelect = document.getElementById('nacionalidade');
    const paisNascimentoGroup = document.getElementById('pais_nascimento').closest('.col-md-4');
    const dataNaturalizacaoGroup = document.getElementById('data_naturalizacao').closest('.col-md-4');
    const portariaNaturalizacaoGroup = document.getElementById('portaria_naturalizacao').closest('.col-md-4');
    const municipioNascimentoGroup = document.getElementById('municipio_nascimento').closest('.col-md-4');
    const ufNascimentoGroup = document.getElementById('uf_nascimento').closest('.col-md-4');
    const dataEntradaBrasilGroup = document.getElementById('data_entrada_brasil').closest('.col-md-4');

    function updateFieldsVisibility() {
        const nacionalidade = nacionalidadeSelect.value;

        // Campos para brasileiros
        municipioNascimentoGroup.style.display = nacionalidade === 'brasileira' ? 'block' : 'none';
        ufNascimentoGroup.style.display = nacionalidade === 'brasileira' ? 'block' : 'none';

        // Campos para naturalizados y extranjeros
        paisNascimentoGroup.style.display = nacionalidade === 'naturalizado' || nacionalidade === 'estrangeiro' ? 'block' : 'none';
        
        // Campos específicos para naturalizados
        dataNaturalizacaoGroup.style.display = nacionalidade === 'naturalizado' ? 'block' : 'none';
        portariaNaturalizacaoGroup.style.display = nacionalidade === 'naturalizado' ? 'block' : 'none';

        // Campos específicos para extranjeros
        dataEntradaBrasilGroup.style.display = nacionalidade === 'estrangeiro' ? 'block' : 'none';

        // Limpiar campos ocultos
        if (nacionalidade === 'brasileira') {
            document.getElementById('pais_nascimento').value = '';
            document.getElementById('data_naturalizacao').value = '';
            document.getElementById('portaria_naturalizacao').value = '';
            document.getElementById('data_entrada_brasil').value = '';
        } else if (nacionalidade === 'naturalizado') {
            document.getElementById('data_entrada_brasil').value = '';
        } else if (nacionalidade === 'estrangeiro') {
            document.getElementById('data_naturalizacao').value = '';
            document.getElementById('portaria_naturalizacao').value = '';
        }
    }

    nacionalidadeSelect.addEventListener('change', updateFieldsVisibility);
    
    // Ejecutar al cargar la página para establecer el estado inicial
    updateFieldsVisibility();

    // Agregar al script existente
    function validateForm() {
        let isValid = true;

        // Validar peso
        const consideracaoPeso = document.getElementById('consideracao_peso');
        if (!consideracaoPeso.value) {
            consideracaoPeso.classList.add('is-invalid');
            isValid = false;
        }

        // Validar campos condicionales
        if (document.getElementById('esta_gestante').checked) {
            const maternidade = document.getElementById('maternidade_referencia');
            if (!maternidade.value) {
                maternidade.classList.add('is-invalid');
            isValid = false;
            }
        }

        // ... otras validaciones similares para los demás campos condicionales ...

        return isValid;
    }

    // Agregar al form el evento submit
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
        }
    });

    // Limpiar validación cuando se marca como desconocido (padre)
    paiDesconhecido.addEventListener('change', function() {
        if (this.checked) {
            nomePai.classList.remove('is-invalid');
            const feedback = nomePai.nextElementSibling;
            if (feedback && feedback.className === 'invalid-feedback') {
                feedback.remove();
            }
        }
    });

    // Agregar al script existente
    const responsavelFamiliar = document.getElementById('responsavel_familiar');
    const dadosResponsavel = document.getElementById('dados_responsavel');

    responsavelFamiliar.addEventListener('change', function() {
        dadosResponsavel.style.display = this.checked ? 'none' : 'flex';
        if (this.checked) {
            document.getElementById('cns_responsavel').value = '';
            document.getElementById('cpf_responsavel').value = '';
        }
    });

    // Ejecutar al cargar la página
    dadosResponsavel.style.display = responsavelFamiliar.checked ? 'none' : 'flex';

    // Calcular edad y mostrar/ocultar campos de criança
    const dataNascimento = document.getElementById('data_nascimento');
    const criancaContainer = document.getElementById('crianca-container');
    
    function calcularIdade(dataNasc) {
        const hoje = new Date();
        const nascimento = new Date(dataNasc.split('/').reverse().join('-'));
        let idade = hoje.getFullYear() - nascimento.getFullYear();
        const m = hoje.getMonth() - nascimento.getMonth();
        if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) {
            idade--;
        }
        return idade;
    }

    function verificarIdade() {
        if (dataNascimento.value) {
            const idade = calcularIdade(dataNascimento.value);
            criancaContainer.style.display = idade <= 9 ? 'block' : 'none';
        }
    }

    dataNascimento.addEventListener('change', verificarIdade);
    verificarIdade();

    // Comunidade Tradicional
    const membroComunidade = document.getElementById('membro_comunidade');
    const qualComunidadeContainer = document.getElementById('qual-comunidade-container');

    membroComunidade.addEventListener('change', function() {
        qualComunidadeContainer.style.display = this.checked ? 'block' : 'none';
    });

    // Orientação Sexual
    const informaOrientacao = document.getElementById('informa_orientacao');
    const orientacaoContainer = document.getElementById('orientacao-container');

    informaOrientacao.addEventListener('change', function() {
        orientacaoContainer.style.display = this.checked ? 'block' : 'none';
    });

    // Identidade de Gênero
    const informaIdentidade = document.getElementById('informa_identidade');
    const identidadeContainer = document.getElementById('identidade-container');

    informaIdentidade.addEventListener('change', function() {
        identidadeContainer.style.display = this.checked ? 'block' : 'none';
    });

    // Saída do Cadastro
    const motivoSaida = document.getElementById('motivo_saida');
    const dataObitoContainer = document.getElementById('data-obito-container');
    const numeroDOContainer = document.getElementById('numero-do-container');

    motivoSaida.addEventListener('change', function() {
        const isObito = this.value === 'obito';
        dataObitoContainer.style.display = isObito ? 'block' : 'none';
        numeroDOContainer.style.display = isObito ? 'block' : 'none';
    });

    // Gestante
    const estaGestante = document.getElementById('esta_gestante');
    const maternidadeContainer = document.getElementById('maternidade-container');

    estaGestante.addEventListener('change', function() {
        maternidadeContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('maternidade_referencia').value = '';
        }
    });

    // Doença Respiratória
    const temDoencaRespiratoria = document.getElementById('tem_doenca_respiratoria');
    const doencaRespiratoriaContainer = document.getElementById('doenca-respiratoria-container');

    temDoencaRespiratoria.addEventListener('change', function() {
        doencaRespiratoriaContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('tipo_doenca_respiratoria').value = '';
        }
    });

    // Doença Cardíaca
    const temDoencaCardiaca = document.getElementById('tem_doenca_cardiaca');
    const doencaCardiacaContainer = document.getElementById('doenca-cardiaca-container');

    temDoencaCardiaca.addEventListener('change', function() {
        doencaCardiacaContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('tipo_doenca_cardiaca').value = '';
        }
    });

    // Problemas Renais
    const temProblemaRins = document.getElementById('tem_problema_rins');
    const problemaRinsContainer = document.getElementById('problema-rins-container');

    temProblemaRins.addEventListener('change', function() {
        problemaRinsContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('tipo_problema_rins').value = '';
        }
    });

    // Ejecutar al cargar la página para establecer estados iniciales
    maternidadeContainer.style.display = estaGestante.checked ? 'block' : 'none';
    doencaRespiratoriaContainer.style.display = temDoencaRespiratoria.checked ? 'block' : 'none';
    doencaCardiacaContainer.style.display = temDoencaCardiaca.checked ? 'block' : 'none';
    problemaRinsContainer.style.display = temProblemaRins.checked ? 'block' : 'none';

    // Deficiência
    const temDeficiencia = document.getElementById('tem_deficiencia');
    const deficienciasContainer = document.getElementById('deficiencias-container');

    temDeficiencia.addEventListener('change', function() {
        deficienciasContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            const select = document.getElementById('deficiencias');
            Array.from(select.options).forEach(option => option.selected = false);
        }
    });

    // Situação de Rua
    const situacaoRua = document.getElementById('situacao_rua');
    const situacaoRuaContainer = document.getElementById('situacao-rua-container');

    situacaoRua.addEventListener('change', function() {
        situacaoRuaContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('tempo_rua').value = '';
        }
    });

    // Acompanhamento Institucional
    const acompanhadoInstituicao = document.getElementById('acompanhado_instituicao');
    const instituicaoContainer = document.getElementById('instituicao-container');

    acompanhadoInstituicao.addEventListener('change', function() {
        instituicaoContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('qual_instituicao').value = '';
        }
    });

    // Benefícios
    const recebeBeneficio = document.getElementById('recebe_beneficio');
    const beneficioContainer = document.getElementById('beneficio-container');

    recebeBeneficio.addEventListener('change', function() {
        beneficioContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('qual_beneficio').value = '';
        }
    });

    // Referência Familiar
    const possuiReferencia = document.getElementById('possui_referencia_familiar');
    const referenciaContainer = document.getElementById('referencia-familiar-container');

    possuiReferencia.addEventListener('change', function() {
        referenciaContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('grau_parentesco').value = '';
        }
    });

    // Visitas Familiares
    const visitaFamiliar = document.getElementById('visita_familiar');
    const visitaContainer = document.getElementById('visita-familiar-container');

    visitaFamiliar.addEventListener('change', function() {
        visitaContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('frequencia_visitas').value = '';
        }
    });

    // Higiene
    const acessoHigiene = document.getElementById('acesso_higiene');
    const higieneContainer = document.getElementById('higiene-container');

    acessoHigiene.addEventListener('change', function() {
        higieneContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            const select = document.getElementById('tipos_higiene');
            Array.from(select.options).forEach(option => option.selected = false);
        }
    });

    // Ejecutar al cargar la página para establecer estados iniciales
    situacaoRuaContainer.style.display = situacaoRua.checked ? 'block' : 'none';
    instituicaoContainer.style.display = acompanhadoInstituicao.checked ? 'block' : 'none';
    beneficioContainer.style.display = recebeBeneficio.checked ? 'block' : 'none';
    referenciaContainer.style.display = possuiReferencia.checked ? 'block' : 'none';
    visitaContainer.style.display = visitaFamiliar.checked ? 'block' : 'none';
    higieneContainer.style.display = acessoHigiene.checked ? 'block' : 'none';

    // Escola/Creche
    const frequentaEscola = document.getElementById('frequenta_escola');
    const cursoContainer = document.getElementById('curso-container');

    frequentaEscola.addEventListener('change', function() {
        if (!this.checked) {
            document.getElementById('curso_frequenta').value = 'nenhum';
        }
    });

    // Ejecutar al cargar la página
    if (!frequentaEscola.checked) {
        document.getElementById('curso_frequenta').value = 'nenhum';
    }

    // Al final del script existente
    const foraArea = document.getElementById('fora_area');
    const microarea = document.getElementById('microarea');
    const microareaOriginal = '{{ current_user.microarea }}';  // Usar la microárea del ACS

    foraArea.addEventListener('change', function() {
        if (this.checked) {
            microarea.value = 'FA';
        } else {
            microarea.value = microareaOriginal;
        }
    });
});
</script>
{% endblock %} 