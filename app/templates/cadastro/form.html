{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Agregar esto para mostrar mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="card">
        <div class="card-header">
            <h2>Cadastro Individual</h2>
        </div>
        <div class="card-body">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" class="needs-validation" novalidate>
                {{ form.csrf_token }}
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form.digitado_por.label(class="form-label") }}
                        {{ form.digitado_por(class="form-control", readonly=true) }}
                    </div>
                    <div class="col-md-6">
                        {{ form.data_digitacao.label(class="form-label") }}
                        {{ form.data_digitacao(class="form-control", readonly=true) }}
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Dados do Profissional</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">CNS do Profissional</label>
                                <p class="form-control-static">{{ dados_profissional.cns_profissional }}</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">CBO</label>
                                <p class="form-control-static">{{ dados_profissional.cbo }}</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">CNES</label>
                                <p class="form-control-static">{{ dados_profissional.cnes }}</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">INE</label>
                                <p class="form-control-static">{{ dados_profissional.ine }}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                {{ form.microarea.label(class="form-label") }}
                                {{ form.microarea(class="form-control", readonly=true) }}
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mt-4">
                                    {{ form.fora_area(class="form-check-input") }}
                                    {{ form.fora_area.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data do Cadastro</label>
                                <p class="form-control-static">{{ dados_profissional.data_cadastro }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Identificação do Cidadão</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.nome_completo.label(class="form-label") }}
                                {{ form.nome_completo(class="form-control" + (" is-invalid" if form.nome_completo.errors else "")) }}
                                {% if form.nome_completo.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.nome_completo.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.nome_social.label(class="form-label") }}
                                {{ form.nome_social(class="form-control") }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.data_nascimento.label(class="form-label") }}
                                {{ form.data_nascimento(class="form-control" + (" is-invalid" if form.data_nascimento.errors else ""),
                                                       placeholder="DD/MM/AAAA",
                                                       maxlength="10") }}
                                <small class="form-text text-muted">Formato: DD/MM/AAAA</small>
                                {% if form.data_nascimento.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.data_nascimento.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.sexo.label(class="form-label") }}
                                {{ form.sexo(class="form-control" + (" is-invalid" if form.sexo.errors else "")) }}
                                {% if form.sexo.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.sexo.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.raca_cor.label(class="form-label") }}
                                {{ form.raca_cor(class="form-control" + (" is-invalid" if form.raca_cor.errors else "")) }}
                                {% if form.raca_cor.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.raca_cor.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3" id="etnia-container" style="display: none;">
                                {{ form.etnia.label(class="form-label") }}
                                {{ form.etnia(class="form-control" + (" is-invalid" if form.etnia.errors else "")) }}
                                {% if form.etnia.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.etnia.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.numero_nis.label(class="form-label") }}
                                {{ form.numero_nis(class="form-control" + (" is-invalid" if form.numero_nis.errors else "")) }}
                                {% if form.numero_nis.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.numero_nis.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    {{ form.nome_mae.label(class="form-label") }}
                                    <div class="form-check">
                                        {{ form.mae_desconhecida(class="form-check-input") }}
                                        {{ form.mae_desconhecida.label(class="form-check-label") }}
                                    </div>
                                </div>
                                {{ form.nome_mae(class="form-control" + (" is-invalid" if form.nome_mae.errors else "")) }}
                                {% if form.nome_mae.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.nome_mae.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    {{ form.nome_pai.label(class="form-label") }}
                                    <div class="form-check">
                                        {{ form.pai_desconhecido(class="form-check-input") }}
                                        {{ form.pai_desconhecido.label(class="form-check-label") }}
                                    </div>
                                </div>
                                {{ form.nome_pai(class="form-control" + (" is-invalid" if form.nome_pai.errors else "")) }}
                                {% if form.nome_pai.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.nome_pai.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.nacionalidade.label(class="form-label") }}
                                {{ form.nacionalidade(class="form-select", id="nacionalidade") }}
                            </div>
                            <div class="col-md-4 mb-3 campo-estrangeiro campo-naturalizado">
                                {{ form.pais_nascimento.label(class="form-label") }}
                                {{ form.pais_nascimento(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3 campo-naturalizado">
                                {{ form.data_naturalizacao.label(class="form-label") }}
                                {{ form.data_naturalizacao(class="form-control") }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3 campo-naturalizado">
                                {{ form.portaria_naturalizacao.label(class="form-label") }}
                                {{ form.portaria_naturalizacao(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3 campo-estrangeiro">
                                {{ form.data_entrada_brasil.label(class="form-label") }}
                                {{ form.data_entrada_brasil(class="form-control") }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.telefone_celular.label(class="form-label") }}
                                {{ form.telefone_celular(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.email.label(class="form-label") }}
                                {{ form.email(class="form-control") }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.cns_cidadao.label(class="form-label") }}
                                {{ form.cns_cidadao(class="form-control" + (" is-invalid" if form.cns_cidadao.errors else "")) }}
                                {% if form.cns_cidadao.errors %}
                                    <div class="invalid-feedback">{{ form.cns_cidadao.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.cpf_cidadao.label(class="form-label") }}
                                {{ form.cpf_cidadao(class="form-control" + (" is-invalid" if form.cpf_cidadao.errors else "")) }}
                                {% if form.cpf_cidadao.errors %}
                                    <div class="invalid-feedback">{{ form.cpf_cidadao.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="form-check">
                                    {{ form.responsavel_familiar(class="form-check-input") }}
                                    {{ form.responsavel_familiar.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <div id="dados_responsavel" class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.cns_responsavel.label(class="form-label") }}
                                {{ form.cns_responsavel(class="form-control" + (" is-invalid" if form.cns_responsavel.errors else "")) }}
                                {% if form.cns_responsavel.errors %}
                                    <div class="invalid-feedback">{{ form.cns_responsavel.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.cpf_responsavel.label(class="form-label") }}
                                {{ form.cpf_responsavel(class="form-control" + (" is-invalid" if form.cpf_responsavel.errors else "")) }}
                                {% if form.cpf_responsavel.errors %}
                                    <div class="invalid-feedback">{{ form.cpf_responsavel.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Informações Sociodemográficas</h5>
                    </div>
                    <div class="card-body">
                        <!-- Relação de Parentesco -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.parentesco_responsavel.label(class="form-label") }}
                                {{ form.parentesco_responsavel(class="form-control" + (" is-invalid" if form.parentesco_responsavel.errors else "")) }}
                                {% if form.parentesco_responsavel.errors %}
                                    <div class="invalid-feedback">{{ form.parentesco_responsavel.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Escola/Creche -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.frequenta_escola(class="form-check-input") }}
                                    {{ form.frequenta_escola.label(class="form-check-label") }}
                                </div>
                                <div id="curso-container">
                                    {{ form.curso_frequenta.label(class="form-label") }}
                                    {{ form.curso_frequenta(class="form-select" + (" is-invalid" if form.curso_frequenta.errors else "")) }}
                                    {% if form.curso_frequenta.errors %}
                                        <div class="invalid-feedback">{{ form.curso_frequenta.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Situação no Mercado de Trabalho -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.situacao_trabalho.label(class="form-label") }}
                                {{ form.situacao_trabalho(class="form-select" + (" is-invalid" if form.situacao_trabalho.errors else "")) }}
                                {% if form.situacao_trabalho.errors %}
                                    <div class="invalid-feedback">{{ form.situacao_trabalho.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Ocupação -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.ocupacao.label(class="form-label") }}
                                {{ form.ocupacao(class="form-control" + (" is-invalid" if form.ocupacao.errors else "")) }}
                                {% if form.ocupacao.errors %}
                                    <div class="invalid-feedback">{{ form.ocupacao.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Crianças 0-9 anos -->
                        <div class="row mb-3" id="crianca-container">
                            <div class="col-md-6">
                                {{ form.crianca_ficacom.label(class="form-label") }}
                                {{ form.crianca_ficacom(class="form-control") }}
                            </div>
                        </div>

                        <!-- Campos Sim/Não -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.frequenta_cuidador(class="form-check-input") }}
                                    {{ form.frequenta_cuidador.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.participa_grupo(class="form-check-input") }}
                                    {{ form.participa_grupo.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.possui_plano_saude(class="form-check-input") }}
                                    {{ form.possui_plano_saude.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Comunidade Tradicional -->
                        <div class="form-group">
                            {{ form.membro_comunidade.label(class="form-label") }}
                            {{ form.membro_comunidade(class="form-check-input", id="membro_comunidade") }}
                            
                            <div id="qual_comunidade_div" style="display: none;">
                                    {{ form.qual_comunidade.label(class="form-label") }}
                                {{ form.qual_comunidade(class="form-control") }}
                            </div>
                        </div>

                        <!-- Orientação Sexual -->
                        <div class="form-group">
                            {{ form.informa_orientacao.label(class="form-label") }}
                            {{ form.informa_orientacao(class="form-check-input", id="informa_orientacao") }}
                            
                            <div id="orientacao_sexual_div" style="display: none;">
                                    {{ form.orientacao_sexual.label(class="form-label") }}
                                {{ form.orientacao_sexual(class="form-control") }}
                            </div>
                        </div>

                        <!-- Identidade de Gênero -->
                        <div class="form-group">
                            {{ form.informa_identidade.label(class="form-label") }}
                            {{ form.informa_identidade(class="form-check-input", id="informa_identidade") }}
                            
                            <div id="identidade_genero_div" style="display: none;">
                                    {{ form.identidade_genero.label(class="form-label") }}
                                {{ form.identidade_genero(class="form-control") }}
                            </div>
                        </div>

                        <!-- Deficiência -->
                        <div class="form-group">
                            {{ form.tem_deficiencia.label(class="form-label") }}
                            {{ form.tem_deficiencia(class="form-check-input", id="tem_deficiencia") }}
                            
                            <div id="deficiencias_div" style="display: none;">
                                    {{ form.deficiencias.label(class="form-label") }}
                                {{ form.deficiencias(class="form-select") }}
                            </div>
                        </div>

                        <!-- Saída do Cadastro -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                {{ form.motivo_saida.label(class="form-label") }}
                                {{ form.motivo_saida(class="form-control") }}
                            </div>
                            <div class="col-md-4" id="data-obito-container" style="display: none;">
                                {{ form.data_obito.label(class="form-label") }}
                                {{ form.data_obito(class="form-control" + (" is-invalid" if form.data_obito.errors else "")) }}
                                {% if form.data_obito.errors %}
                                    <div class="invalid-feedback">{{ form.data_obito.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4" id="numero-do-container" style="display: none;">
                                {{ form.numero_do.label(class="form-label") }}
                                {{ form.numero_do(class="form-control" + (" is-invalid" if form.numero_do.errors else "")) }}
                                {% if form.numero_do.errors %}
                                    <div class="invalid-feedback">{{ form.numero_do.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- TRIA -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <h6 class="mb-3">Triagem para Risco de Insegurança Alimentar (TRIA)</h6>
                                <div class="form-check mb-2">
                                    {{ form.tria_alimentos_acabaram(class="form-check-input") }}
                                    {{ form.tria_alimentos_acabaram.label(class="form-check-label") }}
                                </div>
                                <div class="form-check">
                                    {{ form.tria_comeu_alguns(class="form-check-input") }}
                                    {{ form.tria_comeu_alguns.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Condições/Situações de Saúde</h5>
                    </div>
                    <div class="card-body">
                        <!-- Gestante -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.esta_gestante(class="form-check-input") }}
                                    {{ form.esta_gestante.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-8" id="maternidade-container" style="display: none;">
                                {{ form.maternidade_referencia.label(class="form-label") }}
                                {{ form.maternidade_referencia(class="form-control" + (" is-invalid" if form.maternidade_referencia.errors else "")) }}
                                {% if form.maternidade_referencia.errors %}
                                    <div class="invalid-feedback">{{ form.maternidade_referencia.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Peso -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.consideracao_peso.label(class="form-label") }}
                                <span class="text-danger">*</span>
                                {{ form.consideracao_peso(class="form-control" + (" is-invalid" if form.consideracao_peso.errors else "")) }}
                                {% if form.consideracao_peso.errors %}
                                    <div class="invalid-feedback">{{ form.consideracao_peso.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Doença Respiratória -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.tem_doenca_respiratoria(class="form-check-input") }}
                                    {{ form.tem_doenca_respiratoria.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-8" id="doenca-respiratoria-container" style="display: none;">
                                {{ form.tipo_doenca_respiratoria.label(class="form-label") }}
                                {{ form.tipo_doenca_respiratoria(class="form-control" + (" is-invalid" if form.tipo_doenca_respiratoria.errors else "")) }}
                                {% if form.tipo_doenca_respiratoria.errors %}
                                    <div class="invalid-feedback">{{ form.tipo_doenca_respiratoria.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Hábitos -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.fumante(class="form-check-input") }}
                                    {{ form.fumante.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.uso_alcool(class="form-check-input") }}
                                    {{ form.uso_alcool.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.uso_drogas(class="form-check-input") }}
                                    {{ form.uso_drogas.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Doenças Crônicas -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="form-check">
                                    {{ form.hipertensao_arterial(class="form-check-input") }}
                                    {{ form.hipertensao_arterial.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    {{ form.diabetes(class="form-check-input") }}
                                    {{ form.diabetes.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    {{ form.teve_avc(class="form-check-input") }}
                                    {{ form.teve_avc.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    {{ form.teve_infarto(class="form-check-input") }}
                                    {{ form.teve_infarto.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Doença Cardíaca -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.tem_doenca_cardiaca(class="form-check-input") }}
                                    {{ form.tem_doenca_cardiaca.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-8" id="doenca-cardiaca-container" style="display: none;">
                                {{ form.tipo_doenca_cardiaca.label(class="form-label") }}
                                {{ form.tipo_doenca_cardiaca(class="form-control" + (" is-invalid" if form.tipo_doenca_cardiaca.errors else "")) }}
                                {% if form.tipo_doenca_cardiaca.errors %}
                                    <div class="invalid-feedback">{{ form.tipo_doenca_cardiaca.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Problemas Renais -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.tem_problema_rins(class="form-check-input") }}
                                    {{ form.tem_problema_rins.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-8" id="problema-rins-container" style="display: none;">
                                {{ form.tipo_problema_rins.label(class="form-label") }}
                                {{ form.tipo_problema_rins(class="form-control" + (" is-invalid" if form.tipo_problema_rins.errors else "")) }}
                                {% if form.tipo_problema_rins.errors %}
                                    <div class="invalid-feedback">{{ form.tipo_problema_rins.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Outras Doenças -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.hanseniase(class="form-check-input") }}
                                    {{ form.hanseniase.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.tuberculose(class="form-check-input") }}
                                    {{ form.tuberculose.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.cancer(class="form-check-input") }}
                                    {{ form.cancer.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Situações de Saúde -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.internacao_12_meses(class="form-check-input") }}
                                    {{ form.internacao_12_meses.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.problema_saude_mental(class="form-check-input") }}
                                    {{ form.problema_saude_mental.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.acamado(class="form-check-input") }}
                                    {{ form.acamado.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.domiciliado(class="form-check-input") }}
                                    {{ form.domiciliado.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Práticas Integrativas -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.usa_plantas_medicinais(class="form-check-input") }}
                                    {{ form.usa_plantas_medicinais.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.usa_praticas_integrativas(class="form-check-input") }}
                                    {{ form.usa_praticas_integrativas.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Outras Condições -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {{ form.outras_condicoes.label(class="form-label") }}
                                {{ form.outras_condicoes(class="form-control" + (" is-invalid" if form.outras_condicoes.errors else ""),
                                                     placeholder="Digite até 3 outras condições de saúde, separadas por vírgula") }}
                                {% if form.outras_condicoes.errors %}
                                    <div class="invalid-feedback">{{ form.outras_condicoes.errors[0] }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Separe as condições por vírgula. Máximo de 3 condições.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Situação de Rua</h5>
                    </div>
                    <div class="card-body">
                        <!-- Situação de Rua -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.situacao_rua(class="form-check-input") }}
                                    {{ form.situacao_rua.label(class="form-check-label") }}
                                </div>
                                <div id="situacao-rua-container" style="display: none;">
                                    {{ form.tempo_rua.label(class="form-label") }}
                                    {{ form.tempo_rua(class="form-select" + (" is-invalid" if form.tempo_rua.errors else "")) }}
                                    {% if form.tempo_rua.errors %}
                                        <div class="invalid-feedback">{{ form.tempo_rua.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Acompanhamento Institucional -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check mb-2">
                                    {{ form.acompanhado_instituicao(class="form-check-input") }}
                                    {{ form.acompanhado_instituicao.label(class="form-check-label") }}
                                </div>
                                <div id="instituicao-container" style="display: none;">
                                    {{ form.qual_instituicao.label(class="form-label") }}
                                    {{ form.qual_instituicao(class="form-control" + (" is-invalid" if form.qual_instituicao.errors else "")) }}
                                    {% if form.qual_instituicao.errors %}
                                        <div class="invalid-feedback">{{ form.qual_instituicao.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Benefício -->
                        <div class="form-group">
                            {{ form.recebe_beneficio.label(class="form-label") }}
                            {{ form.recebe_beneficio(class="form-check-input", id="recebe_beneficio") }}
                            
                            <div id="beneficio_div" style="display: none;">
                                    {{ form.qual_beneficio.label(class="form-label") }}
                                {{ form.qual_beneficio(class="form-control") }}
                            </div>
                        </div>

                        <!-- Referência Familiar -->
                        <div class="form-group">
                            {{ form.possui_referencia_familiar.label(class="form-label") }}
                            {{ form.possui_referencia_familiar(class="form-check-input", id="possui_referencia_familiar") }}
                            
                            <div id="parentesco_div" style="display: none;">
                                    {{ form.grau_parentesco.label(class="form-label") }}
                                {{ form.grau_parentesco(class="form-control") }}
                            </div>
                        </div>

                        <!-- Visita Familiar -->
                        <div class="form-group">
                            {{ form.visita_familiar.label(class="form-label") }}
                            {{ form.visita_familiar(class="form-check-input", id="visita_familiar") }}
                            
                            <div id="frequencia_div" style="display: none;">
                                    {{ form.frequencia_visitas.label(class="form-label") }}
                                {{ form.frequencia_visitas(class="form-control") }}
                            </div>
                        </div>

                        <!-- Higiene -->
                        <div class="form-group">
                            {{ form.acesso_higiene.label(class="form-label") }}
                            {{ form.acesso_higiene(class="form-check-input", id="acesso_higiene") }}
                            
                            <div id="higiene_div" style="display: none;">
                                {{ form.tipos_higiene.label(class="form-label") }}
                                {{ form.tipos_higiene(class="form-select") }}
                            </div>
                        </div>

                        <!-- Alimentação -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.quantidade_alimentacao.label(class="form-label") }}
                                {{ form.quantidade_alimentacao(class="form-control" + (" is-invalid" if form.quantidade_alimentacao.errors else "")) }}
                                {% if form.quantidade_alimentacao.errors %}
                                    <div class="invalid-feedback">{{ form.quantidade_alimentacao.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {{ form.origem_alimentacao.label(class="form-label") }}
                                {{ form.origem_alimentacao(class="form-select" + (" is-invalid" if form.origem_alimentacao.errors else "")) }}
                                {% if form.origem_alimentacao.errors %}
                                    <div class="invalid-feedback">{{ form.origem_alimentacao.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer text-end">
                    <a href="{{ url_for('cadastro.lista_cadastros') }}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Salvar Cadastro</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.is-valid {
    border-color: #198754 !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.is-invalid {
    border-color: #dc3545 !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Estilo para campos con error */
.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* Animación de shake para campos con error */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.shake-error {
    animation: shake 0.5s ease-in-out;
}

/* Estilo para el toast de error */
.error-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    min-width: 300px;
    background-color: white;
    border-left: 4px solid #dc3545;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1050;
    padding: 1rem;
    border-radius: 4px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.toast-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    font-weight: bold;
    color: #dc3545;
}

.toast-body {
    color: #666;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lista de TODOS los pares checkbox-campo
    const conditionalPairs = [
        // Campos que ya funcionan
        {checkbox: 'recebe_beneficio', container: 'beneficio_div'},
        {checkbox: 'possui_referencia_familiar', container: 'parentesco_div'},
        {checkbox: 'visita_familiar', container: 'frequencia_div'},
        {checkbox: 'acesso_higiene', container: 'higiene_div'},
        {checkbox: 'membro_comunidade', container: 'qual_comunidade_div'},
        {checkbox: 'informa_orientacao', container: 'orientacao_sexual_div'},
        {checkbox: 'informa_identidade', container: 'identidade_genero_div'},
        {checkbox: 'tem_deficiencia', container: 'deficiencias_div'},
        
        // Campos de salud que necesitan ser agregados
        {checkbox: 'tem_doenca_respiratoria', container: 'doenca-respiratoria-container'},
        {checkbox: 'tem_doenca_cardiaca', container: 'doenca-cardiaca-container'},
        {checkbox: 'tem_problema_rins', container: 'problema-rins-container'},
        {checkbox: 'outras_condicoes_saude', container: 'outras-condicoes-container'},
        {checkbox: 'esta_gestante', container: 'maternidade-container'},
        {checkbox: 'situacao_rua', container: 'situacao-rua-container'},
        {checkbox: 'acompanhado_instituicao', container: 'instituicao-container'}
    ];

    // Configurar los campos condicionales
    conditionalPairs.forEach(pair => {
        const checkbox = document.getElementById(pair.checkbox);
        const container = document.getElementById(pair.container);
        
        if (checkbox && container) {
            // Mostrar/ocultar al cargar la página
            container.style.display = checkbox.checked ? 'block' : 'none';
            
            // Event listener para cambios
            checkbox.addEventListener('change', function() {
                container.style.display = this.checked ? 'block' : 'none';
            });
        }
    });

    // Manejo de errores
    function handleFormErrors() {
        // Obtener todos los campos con error
        const invalidFields = document.querySelectorAll('.is-invalid');
        
        if (invalidFields.length > 0) {
            // Scroll al primer campo con error
            invalidFields[0].scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center'
            });
            
            // Agregar efecto de shake al campo
            invalidFields[0].classList.add('shake-error');
            
            // Mostrar mensaje de error en un toast
            const errorMessage = invalidFields[0].nextElementSibling?.textContent || 'Por favor, corrija los campos marcados en rojo.';
            showErrorToast(errorMessage);
        }
    }

    // Función para mostrar toast de error
    function showErrorToast(message) {
        const toast = document.createElement('div');
        toast.className = 'error-toast';
        toast.innerHTML = `
            <div class="toast-header">
                <i class="fas fa-exclamation-circle text-danger"></i>
                <strong class="ms-2">Error de Validación</strong>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        document.body.appendChild(toast);
        
        // Remover el toast después de 5 segundos
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    // Llamar a la función si hay errores al cargar la página
    handleFormErrors();

    // Máscara para teléfono celular (formato brasileño)
    const telefoneInput = document.getElementById('telefone_celular');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                // Formato: (XX) XXXXX-XXXX
                if (value.length > 2) {
                    value = '(' + value.substring(0,2) + ') ' + value.substring(2);
                }
                if (value.length > 10) {
                    value = value.substring(0,10) + '-' + value.substring(10);
                }
                e.target.value = value;
            } else {
                e.target.value = value.substring(0,11);
            }
        });

        // Validación del formato
        telefoneInput.addEventListener('blur', function(e) {
            const regex = /^\(\d{2}\) \d{5}-\d{4}$/;
            if (e.target.value && !regex.test(e.target.value)) {
                e.target.classList.add('is-invalid');
                if (!e.target.nextElementSibling?.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = 'Formato inválido. Use (XX) XXXXX-XXXX';
                    e.target.parentNode.appendChild(feedback);
                }
            } else {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback?.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
            }
        });
    }

    // Campos condicionales para nacionalidad
    const nacionalidadeSelect = document.getElementById('nacionalidade');
    const camposEstrangeiro = document.querySelectorAll('.campo-estrangeiro');
    const camposNaturalizado = document.querySelectorAll('.campo-naturalizado');
    
    if (nacionalidadeSelect) {
        function toggleCamposNacionalidade() {
            const nacionalidade = nacionalidadeSelect.value;
            console.log('Nacionalidade selecionada:', nacionalidade); // Para debug
            
            // Ocultar todos los campos primero
            camposEstrangeiro.forEach(campo => campo.style.display = 'none');
            camposNaturalizado.forEach(campo => campo.style.display = 'none');
            
            // Mostrar campos según la nacionalidad
            if (nacionalidade === 'estrangeira') {
                camposEstrangeiro.forEach(campo => {
                    campo.style.display = 'block';
                    console.log('Mostrando campo estrangeiro:', campo); // Para debug
                });
            } else if (nacionalidade === 'naturalizada') {
                camposNaturalizado.forEach(campo => {
                    campo.style.display = 'block';
                    console.log('Mostrando campo naturalizado:', campo); // Para debug
                });
            }
        }

    // Ejecutar al cargar la página
        toggleCamposNacionalidade();
        
        // Ejecutar cuando cambie la selección
        nacionalidadeSelect.addEventListener('change', toggleCamposNacionalidade);
    }
});
</script>

<!-- Agregar después del formulario -->
{% if historico %}
<div class="card mt-4">
    <div class="card-header">
        <h4>Histórico de Modificações</h4>
    </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Modificado por</th>
                    <th>Descrição</th>
                </tr>
            </thead>
            <tbody>
                {% for registro in historico %}
                <tr>
                    <td>{{ registro.data_modificacao.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>{{ registro.modificado_por }}</td>
                    <td>{{ registro.descricao }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %} 